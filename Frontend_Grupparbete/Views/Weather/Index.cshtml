@{
    ViewBag.Title = "Weather";
}

<style>
    .weathericon {
        font-size: 4em;
        margin-top: 10px;
        margin-bottom: 10px;
    }

    .daily-div {
        text-align: center;
        padding-top: 10px;
        position: relative;
    }

    #daily hr {
        margin-bottom: 10px;
        margin-top: 10px;
    }

    .center-day-and-icon {
        text-align: center;
    }

    .col-split:first-of-type {
        padding-right: 0;
    }

    .col-split:last-of-type {
        padding-left: 0;
    }

    .hourly-2xfont {
        font-size: 2em;
    }

    .font-1-5-em {
        font-size: 1.5em;
    }

    #hourly-content .row:first-child {
        margin-top: 20px;
    }

    #hourly-content h3 {
        margin-top: 10px;
    }

    @@media (max-width: 768px) {
        #daily .image-wrapper {
            border-top: 2px gray solid;
            /*background-position-x: 0 !important;*/
        }

        .daily-div {
            margin-top: 20px;
        }

        .tab-content div {
            text-align: center;
        }

        .col-split {
            padding-right: 0;
            padding-left: 0;
        }
    }

    #now .row:first-child {
        margin-top: 20px;
    }

    .image-wrapper {
        height: 100%;
        background-repeat: no-repeat;
        background-size: cover;
        position: absolute;
        opacity: 0.3;
        left: 10px;
        right: 10px;
    }

    .background-pos-0 {
        background-position-x: 0;
    }

    .background-pos-68 {
        background-position-x: -68px;
    }

    .background-pos-100 {
        background-position-x: -100px;
    }

    .background-pos-168 {
        background-position-x: -168px;
    }

    .background-pos-300 {
        background-position-x: -300px;
    }

    .background-pos-385 {
        background-position-x: -385px;
    }

</style>

<h2>
    Weather
    <input type="text" class="form-control" id="search-location" style="display: inline-block;" value="Stockholm" />
    <input type="button" class="btn btn-default" id="search" value="Search" />
</h2>
<br />
<div><span class="h3">Location</span>&nbsp;<span id="location"></span></div>
<div><span class="h4">Timezone</span>&nbsp;<span id="timezone"></span></div>
<hr />

<div>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
        <li role="presentation"><a href="#now" aria-controls="now" role="tab" data-toggle="tab">Now</a></li>
        <li role="presentation" class="active"><a href="#daily" aria-controls="daily" role="tab" data-toggle="tab">Daily</a></li>
        <li role="presentation"><a href="#hourly" aria-controls="hourly" role="tab" data-toggle="tab">Hourly</a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane" id="now">
            <div class="row">
                <div class="col-md-offset-3 col-md-6" id="currently">

                </div>
            </div>
        </div>
        <div role="tabpanel" class="tab-pane active" id="daily">
            <div class="row" style="margin-top: 20px;">
                <div class="col-md-6 col-split">
                    <div class="col-md-3"><div id="daily-0"></div></div>
                    <div class="col-md-3"><div id="daily-1"></div></div>
                    <div class="col-md-3"><div id="daily-2"></div></div>
                    <div class="col-md-3"><div id="daily-3"></div></div>
                </div>
                <div class="col-md-6 col-split">
                    <div class="col-md-3"><div id="daily-4"></div></div>
                    <div class="col-md-3"><div id="daily-5"></div></div>
                    <div class="col-md-3"><div id="daily-6"></div></div>
                    <div class="col-md-3"><div id="daily-7"></div></div>
                </div>
            </div>
        </div>
        <div role="tabpanel" class="tab-pane" id="hourly">
            <div class="col-md-offset-1 col-md-10" id="hourly-content"></div>
        </div>
    </div>

</div>


<script type="text/javascript" src="https://maps.google.com/maps/api/js"></script>

<script>
    $(function () {

        $('#search').click(function () {

            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': $('#search-location').val() }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    console.log("Latitude: " + results[0].geometry.location.lat());
                    console.log("Longitude: " + results[0].geometry.location.lng());
                    console.log(results);

                    var latitude = results[0].geometry.location.lat();
                    var longitude = results[0].geometry.location.lng();

                    $.ajax({
                        url: 'https://api.forecast.io/forecast/44c7cdd00e0f82699006ed275eb2b6cf/' + latitude + ',' + longitude + '?units=si',
                        type: 'GET',
                        dataType: 'jsonp',
                        success: function (data, textStatus, xhr) {
                            console.log(data);
                            updateWeather(data);
                            $('#location').html($('#search-location').val());
                        },
                        error: function (xhr, textStatus, errorThrown) {
                            console.log('Error in Operation');
                        },
                        complete: function () {
                            $('body').tooltip({ selector: '[data-toggle="tooltip"]' });
                            setTimeout(function () {
                                setTooltipAndImagePositions();
                            }, 100);
                        }
                    });

                } else {
                    alert('Invalid address: ' + $('#search-location').val());
                }
            });
        });

        $(window).resize(function () {
            setTooltipAndImagePositions();
        });

    });

    function setTooltipAndImagePositions() {
        if ($(window).width() < 768) {
            $.each($('[data-toggle="tooltip"]'), function () {
                $(this).attr('data-placement', 'bottom');
            });

            $.each($('#daily .image-wrapper'), function () {
                var imgurl = $(this).css('background-image').replace(/.*\s?url\([\'\"]?/, '').replace(/[\'\"]?\).*/, '');
                var img = imgurl.substr(imgurl.lastIndexOf('/') + 1);
                $('#' + this.id).removeClass('background-pos-0').removeClass('background-pos-100').removeClass('background-pos-168').removeClass('background-pos-300').removeClass('background-pos-385').removeClass('background-pos-68');
                if (img === "wind.jpg") {
                    $('#' + this.id).addClass('background-pos-100');
                } else {
                    $('#' + this.id).addClass('background-pos-0');
                }
            });

        } else {
            $.each($('[data-toggle="tooltip"]'), function () {
                if (!$(this).hasClass('tooltip-bottom')) {
                    $(this).attr('data-placement', 'left');
                }
            });

            $.each($('#daily .image-wrapper'), function () {
                var imgurl = $(this).css('background-image').replace(/.*\s?url\([\'\"]?/, '').replace(/[\'\"]?\).*/, '');
                var img = imgurl.substr(imgurl.lastIndexOf('/') + 1);
                $('#' + this.id).removeClass('background-pos-0').removeClass('background-pos-100').removeClass('background-pos-168').removeClass('background-pos-300').removeClass('background-pos-385').removeClass('background-pos-68');
                if (img === "fog.jpg" || img === "clear-night.jpg") {
                    $('#' + this.id).addClass('background-pos-300');
                } else if (img === "wind.jpg") {
                    $('#' + this.id).addClass('background-pos-385');
                } else if (img === "clear-day.jpg") {
                    $('#' + this.id).addClass('background-pos-68');
                } else {
                    $('#' + this.id).addClass('background-pos-168');
                }
            });

        }
    }

    function updateWeather(json) {

        var currently = json.currently;
        var daily = json.daily;
        var hourly = json.hourly;
        var timezone = json.timezone;

        $('#timezone').text(timezone);

        // CURRENTLY
        var jsonNow = {
            time: currently.time,
            summary: currently.summary,
            icon: currently.icon,
            temperature: currently.temperature,
            apparentTemperature: currently.apparentTemperature,
            cloudCover: currently.cloudCover,
            precipIntensity: currently.precipIntensity,
            precipProbability: currently.precipProbability,
            windSpeed: currently.windSpeed,
            windBearing: currently.windBearing
        };
        $.ajax({
            url: '@Url.Action("Currently", "Weather")',
            type: 'get',
            data: jsonNow,
            datatype: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#currently').html(data);
            },
            error: function (request, status, err) {
                //alert(status);
                //alert(err);
            }
        });

        // DAILY
        $.each(daily.data, function (i, item) {

            var jsonDaily = {
                time: item.time,
                summary: item.summary,
                icon: item.icon,
                temperatureMax: item.temperatureMax,
                temperatureMaxTime: item.temperatureMaxTime,
                temperatureMin: item.temperatureMin,
                temperatureMinTime: item.temperatureMinTime,
                cloudCover: item.cloudCover,
                precipIntensity: item.precipIntensity,
                precipIntensityMax: item.precipIntensityMax,
                precipProbability: item.precipProbability,
                windSpeed: item.windSpeed,
                windBearing: item.windBearing,
                sunriseTime: item.sunriseTime,
                sunsetTime: item.sunsetTime,
                moonPhase: item.moonPhase
            };
            $.ajax({
                url: '@Url.Action("Daily", "Weather")',
                type: 'get',
                data: jsonDaily,
                datatype: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    $('#daily-' + i).html(data);
                },
                error: function (request, status, err) {
                    //alert(status);
                    //alert(err);
                }
            });
        });


        // HOURLY
        $.each(hourly.data, function (i, item) {
            $('#hourly-content').append('<div id="hourly-' + i + '"></div>');
            var jsonHourly = {
                time: item.time,
                summary: item.summary,
                icon: item.icon,
                temperature: item.temperature,
                apparentTemperature: item.apparentTemperature,
                cloudCover: item.cloudCover,
                precipIntensity: item.precipIntensity,
                precipProbability: item.precipProbability,
                windSpeed: item.windSpeed,
                windBearing: item.windBearing
            };
            $.ajax({
                url: '@Url.Action("Hourly", "Weather")',
                type: 'get',
                data: jsonHourly,
                datatype: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    $('#hourly-' + i).html(data);
                },
                error: function (request, status, err) {
                    //alert(status);
                    //alert(err);
                }
            });
        });


    }

</script>
